#!/bin/bash
#
# FIXME Description
#
# Copyright (C) 2005, 2006  Charles Bouveyron <charles.bouveyron@free.fr>
# Copyright (C) 2025  Tomáš Hnyk <tomashnyk@gmail.com>
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# Authors: Charles Bouveyron <charles.bouveyron@free.fr>
#          Alessandro Faggiano <>
#          Mathieu Vilaplana <mathieu@creationgif.com>
#          Raphaël Pinson <raphink@raphink.net>

SOURCE_TRANSLATION_TTT
FILE="";
let "nbfiles = ($# -1)/2"
DIR="$1";
trap 'qdbus $dbusRef close 2>/dev/null' EXIT
kdialog --title "$(gettext "Kim")" --yesnocancel "$(gettext "Do you want to create new files?")" --yes-label "$(gettext "Create new")" --no-label "$(gettext "Replace existing")"
case $? in
    1) # Replace existing files!
    dbusRef=`kdialog --progressbar "$(gettext "Kim — Initialising ...")" $nbfiles`
    qdbus $dbusRef showCancelButton true
    counter=0
    newname=`kdialog --inputbox "$(gettext "Choose the new name of images:")" "wallpaper_"`
    for i in "$@";do
        if [ -f "$i" ];then
            #test if cancel button has been pushed
            if [[ "$(qdbus $dbusRef wasCancelled)" == "true" ]] ; then
                exit 1
            fi
            let "counter +=1"
            FILE="$i";
            suff="";
            if [ $counter -lt "10" ];
            then suff="00";
            else   if [ $counter -lt "100" ];
                then suff="0";
                fi
            fi
            qdbus $dbusRef setLabelText "$(gettext "Kim — Renaming file: ") `basename -- "$FILE"`"
            mv "$FILE" "$DIR/$newname$suff$counter.jpg"
            qdbus $dbusRef org.freedesktop.DBus.Properties.Set org.kde.kdialog.ProgressDialog value $counter
        fi;
    done;;

    0) # Create new files
    dbusRef=`kdialog --progressbar "$(gettext "Kim — Initialising ...")" $nbfiles`
    qdbus $dbusRef showCancelButton true
    counter=0
    newname="`kdialog --inputbox "$(gettext "Choose the new name of images:")" "wallpaper_"`"
    for i in "$@";do
        if [ -f "$i" ];then
            #test if cancel button has been pushed
            if [[ "$(qdbus $dbusRef wasCancelled)" == "true" ]] ; then
                exit 1
            fi
            let "counter +=1"
            FILE="$i";
            suff="";
            if [ $counter -lt "10" ];
            then suff="00";
            else   if [ $counter -lt "100" ];
                then suff="0";
                fi
            fi
            qdbus $dbusRef setLabelText "$(gettext "Kim — Renaming file: ") `basename -- "$FILE"`"
            cp "$FILE" "$DIR/$newname$suff$counter.jpg"
            qdbus $dbusRef org.freedesktop.DBus.Properties.Set org.kde.kdialog.ProgressDialog value $counter
        fi;
    done;;

    2) kdialog --title "$(gettext "Kim")" --msgbox "$(gettext "The action was cancelled by the user!")"
    exit 1;;
esac;
