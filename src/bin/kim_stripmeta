#!/bin/bash
#
# Strips metadata using ExifTool while preserving the ICC profile (color management)
#
# Copyright (C) 2026 codesterribly
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# Author: codesterribly

SOURCE_TRANSLATION_TTT
DIR="$1";
let "nbfiles = ($# / 2)"
trap 'qdbus $dbusRef close 2>/dev/null' EXIT
kdialog --title "$(gettext 'Kim')" --yesnocancel "$(gettext 'Do you want to create new files?')" --yes-label "$(gettext 'Create new')" --no-label "$(gettext 'Replace existing')"

case $? in
    1)  # Replace existing files!
    dbusRef=$(kdialog --progressbar "$(gettext 'Kim — Initialising metadate stripping')" $nbfiles)
    qdbus $dbusRef showCancelButton true
    counter=0
    for i in "$@";do
        if [ -f "$i" ];then
            # test if cancel button has been pushed
                if [[ "$(qdbus $dbusRef wasCancelled)" == "true" ]] ; then
                    exit 1
                fi
                let "counter +=1"
                FILE="$i"
                exiftool -overwrite_original -all= -tagsfromfile "$i" -icc_profile -Orientation -- "$i" #>/dev/null 2>&1
                qdbus $dbusRef setLabelText "$(gettext 'Kim — Stripping metadata from file: ') `basename "$FILE"`"
                qdbus $dbusRef org.freedesktop.DBus.Properties.Set org.kde.kdialog.ProgressDialog value $counter
        fi
    done;;

    0) # Create new
    dbusRef=$(kdialog --progressbar "$(gettext 'Kim — Initialising ...')" $nbfiles)
    # $dbusRef expands to "service path" (two args), do not quote it
    qdbus $dbusRef showCancelButton true
    counter=0
    for i in "$@"; do
        if [ -f "$i" ]; then
          # test if cancel button has been pushed
          if [[ "$(qdbus $dbusRef wasCancelled)" == "true" ]] ; then
            exit 1
          fi
          let "counter += 1"
          FILE="$i"
          BASENAME="$(basename "$FILE")"
          NAME="${BASENAME%.*}"
          EXT="${BASENAME##*.}"
          exiftool -all= -tagsfromfile "$i" -icc_profile -Orientation -o "$DIR/${NAME}_stripped.${EXT}" -- "$i" >/dev/null 2>&1
          qdbus $dbusRef setLabelText "$(gettext 'Kim — Stripping metadata from file: ')$BASENAME"
          qdbus $dbusRef org.freedesktop.DBus.Properties.Set org.kde.kdialog.ProgressDialog value $counter
        fi
    done;;

    2) kdialog --title $(gettext 'Kim') --msgbox "$(gettext 'The action was cancelled by the user!')"
    exit 1;;
esac
